<!DOCTYPE html>
<html>
<head>
    <title>Update Reload Task</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch(`/get_reload_task/{{task_id}}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Fetched data:", data); // Log the fetched data
        
                    document.querySelector('input[name="appId"]').value = data.appId || '';
                    document.querySelector('input[name="partial"]').checked = data.partial;
                    document.querySelector('input[name="timeZone"]').value = data.timeZone || '';
                    document.querySelector('input[name="autoReload"]').checked = data.autoReload;
        
                    // Populate the recurrence fields
                    try {
                        const recurrences = data.recurrence || [];
                        recurrences.forEach(ruleString => {
                            // Remove the "RRULE:" prefix before splitting
                            const rules = ruleString.replace("RRULE:", "").split(';');
                            rules.forEach(rule => {
                                const [key, value] = rule.split('=');
                                switch (key) {
                                    case 'FREQ':
                                        document.querySelector('select[name="frequency1"]').value = value;
                                        break;
                                    case 'INTERVAL':
                                        document.querySelector('input[name="interval1"]').value = value;
                                        break;
                                    case 'BYDAY':
                                        value.split(',').forEach(day => {
                                            document.querySelector(`input[name="byDay1"][value="${day}"]`).checked = true;
                                        });
                                        break;
                                    case 'BYHOUR':
                                        document.querySelector('input[name="byHour1"]').value = value;
                                        break;
                                    case 'BYMINUTE':
                                        document.querySelector('input[name="byMinute1"]').value = value;
                                        break;
                                    case 'BYSECOND':
                                        document.querySelector('input[name="bySecond1"]').value = value;
                                        break;
                                }
                            });
                        });
                    } catch (error) {
                        console.error("Error processing recurrence data:", error);
                    }
        
                    document.querySelector('input[name="endDateTime"]').value = data.endDateTime || '';
                    document.querySelector('input[name="startDateTime"]').value = data.startDateTime || '';
                    document.querySelector('input[name="autoReloadPartial"]').checked = data.autoReloadPartial;
                    document.querySelector('select[name="state"]').value = data.state || 'Disabled';
                })
                .catch(error => {
                    console.error("Error fetching task data:", error);
                });
        });

        function user_input_to_icalendar_format(formData) {
            let rrule = "";
            const freq = formData.get('frequency1');
            if (freq) {
                rrule = `RRULE:FREQ=${freq}`;
                const interval = formData.get('interval1');
                if (interval && !isNaN(interval) && Number(interval) > 0) {
                    rrule += `;INTERVAL=${interval}`;
                }
                if (freq === "WEEKLY") {
                    const days = formData.getAll('byDay1');
                    const validDays = ["SU", "MO", "TU", "WE", "TH", "FR", "SA"];
                    const filteredDays = days.filter(day => validDays.includes(day));
                    if (filteredDays.length > 0) {
                        rrule += `;BYDAY=${filteredDays.join(",")}`;
                    }
                }
                for (const unit of ['byHour', 'byMinute', 'bySecond']) {
                    const value = formData.get(`${unit}1`);
                    if (value && !isNaN(value) && Number(value) >= 0) {
                        rrule += `;${unit.toUpperCase()}=${value}`;
                    }
                }
            }
            return rrule ? [rrule] : [];  // Return an array containing the rrule or an empty array
        }
        
        function submitForm(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const recurrenceData = user_input_to_icalendar_format(formData);
            const jsonData = {
                appId: formData.get('appId'),
                partial: formData.get('partial') === 'on',
                timeZone: formData.get('timeZone'),
                autoReload: formData.get('autoReload') === 'on',
                recurrence: recurrenceData,
                endDateTime: formData.get('endDateTime'),
                startDateTime: formData.get('startDateTime'),
                autoReloadPartial: formData.get('autoReloadPartial') === 'on',
                state: formData.get('state')
            };
        
            // Handle empty recurrence
            if (!recurrenceData) {
                delete jsonData.recurrence;  // Omit the recurrence field from the request body
            }
        
            let admin_dashboard_api_key = document.getElementById('admin_dashboard_api_key').value;

            fetch(`/update_reload_task/{{task_id}}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-Key': admin_dashboard_api_key  // use the value from the input field
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.redirect_url) {
                    // If the response contains a redirect URL, redirect to that URL
                    window.location.href = data.redirect_url;
                } else {
                    // Otherwise, show an alert with the message from the response
                    alert(data.message);
                }
            })
            .catch(error => {
                alert(`Failed to update: ${error.message}`);
            });
        }
        
    </script>
</head>
<body>

<h2>Update Reload Task</h2>

<form onsubmit="submitForm(event)">
    Admin Dashboard API Key: <input type="text" id="admin_dashboard_api_key"><br>
    App ID: <input type="text" name="appId"><br>
    Partial: <input type="checkbox" name="partial"><br>
    Time Zone: <input type="text" name="timeZone"><br>
    Auto Reload: <input type="checkbox" name="autoReload"><br>
    Recurrence: 
    <!-- Recurrence: Frequency 1 -->
    <select id="frequency1" name="frequency1">
        <option value="">None</option>
        <option value="HOURLY">Hourly</option>
        <option value="DAILY">Daily</option>
        <option value="WEEKLY">Weekly</option>
        <option value="MONTHLY">Monthly</option>
        <option value="YEARLY">Yearly</option>
    </select>
    
    <!-- Interval 1 -->
    <label for="interval1">Interval:</label>
    <input type="number" id="interval1" name="interval1" min="1" value="1">
    
    <!-- Days of the week 1 -->
    <div id="byDay1">
        <label><input type="checkbox" name="byDay1" value="MO"> Monday</label>
        <label><input type="checkbox" name="byDay1" value="TU"> Tuesday</label>
        <label><input type="checkbox" name="byDay1" value="WE"> Wednesday</label>
        <label><input type="checkbox" name="byDay1" value="TH"> Thursday</label>
        <label><input type="checkbox" name="byDay1" value="FR"> Friday</label>
        <label><input type="checkbox" name="byDay1" value="SA"> Saturday</label>
        <label><input type="checkbox" name="byDay1" value="SU"> Sunday</label>
        <!-- Add other days as needed -->
    </div>
    
    <!-- Time 1 -->
    <label for="byHour1">Hour:</label>
    <input type="number" id="byHour1" name="byHour1" min="0" max="23">
    <label for="byMinute1">Minute:</label>
    <input type="number" id="byMinute1" name="byMinute1" min="0" max="59">
    <label for="bySecond1">Second:</label>
    <input type="number" id="bySecond1" name="bySecond1" min="0" max="59">    
    <br>
    End Date Time: <input type="datetime-local" name="endDateTime"><br>
    Start Date Time: <input type="datetime-local" name="startDateTime"><br>
    Auto Reload Partial: <input type="checkbox" name="autoReloadPartial"><br>
    State: 
    <select name="state">
        <option value="Enabled">Enabled</option>
        <option value="Disabled">Disabled</option>
    </select><br>
    <input type="submit" value="Update">
</form>

</body>
</html>
